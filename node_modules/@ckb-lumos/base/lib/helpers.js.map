{"version":3,"file":"helpers.js","names":["_values","require","_bi","isScriptWrapper","maybeWrapped","script","undefined","isCellMatchQueryOptions","cell","lock","type","argsLen","data","fromBlock","toBlock","wrappedLock","wrappedType","ScriptValue","cellOutput","validate","equals","cellLock","codeHash","hashType","args","startsWith","length","lockArgsLength","minLength","Math","min","slice","blockNumber","BI","from","lt","gt"],"sources":["../src/helpers.ts"],"sourcesContent":["import { ScriptValue } from \"./values\";\nimport { BI } from \"@ckb-lumos/bi\";\n\nimport { Cell, Script } from \"./api\";\nimport { QueryOptions, ScriptWrapper } from \"./indexer\";\n\n/**\n * return if the input is a script wrapper\n * @param maybeWrapped\n */\nexport function isScriptWrapper(\n  maybeWrapped: Script | ScriptWrapper | null\n): maybeWrapped is ScriptWrapper {\n  return (\n    maybeWrapped !== null &&\n    (maybeWrapped as ScriptWrapper).script !== undefined\n  );\n}\n\nexport function isCellMatchQueryOptions(\n  cell: Cell,\n  {\n    lock = undefined,\n    type = undefined,\n    argsLen = -1,\n    data = \"any\",\n    fromBlock = undefined,\n    toBlock = undefined,\n  }: QueryOptions\n): boolean {\n  let wrappedLock: ScriptWrapper | null = null;\n  let wrappedType: \"empty\" | ScriptWrapper | Script | null = null;\n\n  // Wrap the plain `Script` into `ScriptWrapper`.\n  if (lock && !isScriptWrapper(lock)) {\n    wrappedLock = { script: lock, argsLen: argsLen };\n  } else if (lock) {\n    wrappedLock = lock;\n    // check argsLen\n    if (!lock.argsLen) {\n      wrappedLock.argsLen = argsLen;\n    }\n  }\n  if (type && type === \"empty\") {\n    wrappedType = type;\n  } else if (type && typeof type === \"object\" && !isScriptWrapper(type)) {\n    wrappedType = { script: type, argsLen: argsLen };\n  } else if (type && typeof type === \"object\" && isScriptWrapper(type)) {\n    wrappedType = type;\n    // check argsLen\n    if (!type.argsLen) {\n      wrappedType.argsLen = argsLen;\n    }\n  }\n\n  if (wrappedLock && wrappedLock.script && wrappedLock.argsLen === -1) {\n    if (\n      !new ScriptValue(cell.cellOutput.lock, {\n        validate: false,\n      }).equals(new ScriptValue(wrappedLock.script, { validate: false }))\n    ) {\n      return false;\n    }\n  }\n\n  if (wrappedLock && wrappedLock.script && wrappedLock.argsLen === \"any\") {\n    const cellLock = cell.cellOutput.lock;\n    if (\n      cellLock.codeHash !== wrappedLock.script.codeHash ||\n      cellLock.hashType !== wrappedLock.script.hashType ||\n      !cellLock.args.startsWith(wrappedLock.script.args)\n    ) {\n      return false;\n    }\n  }\n\n  if (\n    wrappedLock &&\n    wrappedLock.script &&\n    typeof wrappedLock.argsLen === \"number\" &&\n    wrappedLock.argsLen >= 0\n  ) {\n    const length = wrappedLock.argsLen * 2 + 2;\n    const lockArgsLength = wrappedLock.script.args.length;\n    const minLength = Math.min(length, lockArgsLength);\n\n    const cellLock = cell.cellOutput.lock;\n    if (cellLock.args.length !== length) {\n      return false;\n    }\n    if (\n      !(\n        cellLock.codeHash === wrappedLock.script.codeHash &&\n        cellLock.hashType === wrappedLock.script.hashType &&\n        cellLock.args.slice(0, minLength) ===\n          wrappedLock.script.args.slice(0, minLength)\n      )\n    ) {\n      return false;\n    }\n  }\n\n  if (wrappedType && wrappedType === \"empty\" && cell.cellOutput.type) {\n    return false;\n  }\n  if (wrappedType && typeof wrappedType === \"object\") {\n    if (\n      !cell.cellOutput.type ||\n      !new ScriptValue(cell.cellOutput.type, {\n        validate: false,\n      }).equals(\n        new ScriptValue(wrappedType.script, {\n          validate: false,\n        })\n      )\n    ) {\n      return false;\n    }\n  }\n  if (data && data !== \"any\" && cell.data !== data) {\n    return false;\n  }\n  if (\n    fromBlock &&\n    cell.blockNumber &&\n    BI.from(cell.blockNumber).lt(BI.from(fromBlock))\n  ) {\n    return false;\n  }\n  if (\n    toBlock &&\n    cell.blockNumber &&\n    BI.from(cell.blockNumber).gt(BI.from(toBlock))\n  ) {\n    return false;\n  }\n\n  return true;\n}\n"],"mappings":"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"}