{"version":3,"file":"method.js","names":["_exceptions","require","_abortController","_interopRequireDefault","_crossFetch","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","_classPrivateFieldInitSpec","privateMap","_checkPrivateRedeclaration","set","privateCollection","has","_classPrivateFieldSet","receiver","descriptor","_classExtractFieldDescriptor","_classApplyDescriptorSet","_classPrivateFieldGet","_classApplyDescriptorGet","action","get","_name","WeakMap","_config","_options","_node","Method","name","constructor","node","options","config","method","paramsFormatters","resultFormatters","params","payload","getPayload","controller","AbortController","signal","timeout","setTimeout","abort","fetch","url","headers","body","JSON","stringify","then","json","_classPrivateFieldGet2","_classPrivateFieldGet3","_classPrivateFieldGet4","id","IdNotMatchException","error","ResponseException","result","clearTimeout","data","map","p","i","Math","round","random","jsonrpc","fetch_","exports"],"sources":["../src/method.ts"],"sourcesContent":["import { IdNotMatchException, ResponseException } from \"./exceptions\";\nimport { CKBComponents } from \"./types/api\";\nimport { RPCConfig } from \"./types/common\";\nimport AbortController from \"abort-controller\";\nimport fetch_ from \"cross-fetch\";\n\nexport class Method {\n  #name: string;\n  #config: RPCConfig;\n\n  get name(): string {\n    return this.#name;\n  }\n\n  #options: CKBComponents.Method = {\n    name: \"\",\n    method: \"\",\n    paramsFormatters: [],\n    resultFormatters: undefined,\n  };\n\n  #node: CKBComponents.Node;\n\n  constructor(\n    node: CKBComponents.Node,\n    options: CKBComponents.Method,\n    config: Partial<RPCConfig> = {}\n  ) {\n    this.#node = node;\n    this.#options = options;\n    this.#name = options.name;\n    const { timeout = 30000, fetch = fetch_ } = config;\n    this.#config = { timeout, fetch };\n\n    Object.defineProperty(this.call, \"name\", {\n      value: options.name,\n      configurable: false,\n      writable: false,\n    });\n  }\n\n  /* eslint-disable @typescript-eslint/ban-types, @typescript-eslint/explicit-module-boundary-types */\n  public call = async (...params: (string | number | object)[]) => {\n    const payload = this.getPayload(...params);\n    const controller = new AbortController();\n    const signal = controller.signal as AbortSignal;\n\n    const timeout = setTimeout(() => controller.abort(), this.#config.timeout);\n\n    const res = await this.#config\n      .fetch(this.#node.url, {\n        method: \"POST\",\n        headers: {\n          \"content-type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n        signal,\n      })\n      .then((res) => res.json())\n      .then((res) => {\n        if (res.id !== payload.id) {\n          throw new IdNotMatchException(payload.id, res.id);\n        }\n        if (res.error) {\n          throw new ResponseException(JSON.stringify(res.error));\n        }\n        return this.#options.resultFormatters?.(res.result) ?? res.result;\n      });\n\n    clearTimeout(timeout);\n    return res;\n  };\n\n  public getPayload = (...params: (string | number | object)[]) => {\n    const data = params.map(\n      (p, i) =>\n        (this.#options.paramsFormatters[i] &&\n          this.#options.paramsFormatters[i](p)) ||\n        p\n    );\n    const id = Math.round(Math.random() * 10000);\n    const payload = {\n      id,\n      method: this.#options.method,\n      params: data,\n      jsonrpc: \"2.0\",\n    };\n    return payload;\n  };\n}\n/* eslint-enable @typescript-eslint/ban-types, @typescript-eslint/explicit-module-boundary-types */\n"],"mappings":";;;;;;AAAA,IAAAA,WAAA,GAAAC,OAAA;AAGA,IAAAC,gBAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,WAAA,GAAAD,sBAAA,CAAAF,OAAA;AAAiC,SAAAE,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAAA,SAAAG,gBAAAH,GAAA,EAAAI,GAAA,EAAAC,KAAA,IAAAD,GAAA,GAAAE,cAAA,CAAAF,GAAA,OAAAA,GAAA,IAAAJ,GAAA,IAAAO,MAAA,CAAAC,cAAA,CAAAR,GAAA,EAAAI,GAAA,IAAAC,KAAA,EAAAA,KAAA,EAAAI,UAAA,QAAAC,YAAA,QAAAC,QAAA,oBAAAX,GAAA,CAAAI,GAAA,IAAAC,KAAA,WAAAL,GAAA;AAAA,SAAAM,eAAAM,GAAA,QAAAR,GAAA,GAAAS,YAAA,CAAAD,GAAA,2BAAAR,GAAA,gBAAAA,GAAA,GAAAU,MAAA,CAAAV,GAAA;AAAA,SAAAS,aAAAE,KAAA,EAAAC,IAAA,eAAAD,KAAA,iBAAAA,KAAA,kBAAAA,KAAA,MAAAE,IAAA,GAAAF,KAAA,CAAAG,MAAA,CAAAC,WAAA,OAAAF,IAAA,KAAAG,SAAA,QAAAC,GAAA,GAAAJ,IAAA,CAAAK,IAAA,CAAAP,KAAA,EAAAC,IAAA,2BAAAK,GAAA,sBAAAA,GAAA,YAAAE,SAAA,4DAAAP,IAAA,gBAAAF,MAAA,GAAAU,MAAA,EAAAT,KAAA;AAAA,SAAAU,2BAAAzB,GAAA,EAAA0B,UAAA,EAAArB,KAAA,IAAAsB,0BAAA,CAAA3B,GAAA,EAAA0B,UAAA,GAAAA,UAAA,CAAAE,GAAA,CAAA5B,GAAA,EAAAK,KAAA;AAAA,SAAAsB,2BAAA3B,GAAA,EAAA6B,iBAAA,QAAAA,iBAAA,CAAAC,GAAA,CAAA9B,GAAA,eAAAuB,SAAA;AAAA,SAAAQ,sBAAAC,QAAA,EAAAN,UAAA,EAAArB,KAAA,QAAA4B,UAAA,GAAAC,4BAAA,CAAAF,QAAA,EAAAN,UAAA,UAAAS,wBAAA,CAAAH,QAAA,EAAAC,UAAA,EAAA5B,KAAA,UAAAA,KAAA;AAAA,SAAA8B,yBAAAH,QAAA,EAAAC,UAAA,EAAA5B,KAAA,QAAA4B,UAAA,CAAAL,GAAA,IAAAK,UAAA,CAAAL,GAAA,CAAAN,IAAA,CAAAU,QAAA,EAAA3B,KAAA,iBAAA4B,UAAA,CAAAtB,QAAA,cAAAY,SAAA,gDAAAU,UAAA,CAAA5B,KAAA,GAAAA,KAAA;AAAA,SAAA+B,sBAAAJ,QAAA,EAAAN,UAAA,QAAAO,UAAA,GAAAC,4BAAA,CAAAF,QAAA,EAAAN,UAAA,iBAAAW,wBAAA,CAAAL,QAAA,EAAAC,UAAA;AAAA,SAAAC,6BAAAF,QAAA,EAAAN,UAAA,EAAAY,MAAA,SAAAZ,UAAA,CAAAI,GAAA,CAAAE,QAAA,eAAAT,SAAA,mBAAAe,MAAA,+CAAAZ,UAAA,CAAAa,GAAA,CAAAP,QAAA;AAAA,SAAAK,yBAAAL,QAAA,EAAAC,UAAA,QAAAA,UAAA,CAAAM,GAAA,WAAAN,UAAA,CAAAM,GAAA,CAAAjB,IAAA,CAAAU,QAAA,YAAAC,UAAA,CAAA5B,KAAA;AAAA,IAAAmC,KAAA,oBAAAC,OAAA;AAAA,IAAAC,OAAA,oBAAAD,OAAA;AAAA,IAAAE,QAAA,oBAAAF,OAAA;AAAA,IAAAG,KAAA,oBAAAH,OAAA;AAE1B,MAAMI,MAAM,CAAC;EAIlB,IAAIC,IAAIA,CAAA,EAAW;IACjB,OAAAV,qBAAA,CAAO,IAAI,EAAAI,KAAA;EACb;EAWAO,WAAWA,CACTC,IAAwB,EACxBC,OAA6B,EAC7BC,MAA0B,GAAG,CAAC,CAAC,EAC/B;IAAAzB,0BAAA,OAAAe,KAAA;MAAA7B,QAAA;MAAAN,KAAA;IAAA;IAAAoB,0BAAA,OAAAiB,OAAA;MAAA/B,QAAA;MAAAN,KAAA;IAAA;IAAAoB,0BAAA,OAAAkB,QAAA;MAAAhC,QAAA;MAAAN,KAAA,EAb+B;QAC/ByC,IAAI,EAAE,EAAE;QACRK,MAAM,EAAE,EAAE;QACVC,gBAAgB,EAAE,EAAE;QACpBC,gBAAgB,EAAEjC;MACpB;IAAC;IAAAK,0BAAA,OAAAmB,KAAA;MAAAjC,QAAA;MAAAN,KAAA;IAAA;IAsBD;IAAAF,eAAA,eACc,OAAO,GAAGmD,MAAoC,KAAK;MAC/D,MAAMC,OAAO,GAAG,IAAI,CAACC,UAAU,CAAC,GAAGF,MAAM,CAAC;MAC1C,MAAMG,UAAU,GAAG,IAAIC,wBAAe,CAAC,CAAC;MACxC,MAAMC,MAAM,GAAGF,UAAU,CAACE,MAAqB;MAE/C,MAAMC,OAAO,GAAGC,UAAU,CAAC,MAAMJ,UAAU,CAACK,KAAK,CAAC,CAAC,EAAE1B,qBAAA,KAAI,EAAAM,OAAA,EAASkB,OAAO,CAAC;MAE1E,MAAMvC,GAAG,GAAG,MAAMe,qBAAA,KAAI,EAAAM,OAAA,EACnBqB,KAAK,CAAC3B,qBAAA,KAAI,EAAAQ,KAAA,EAAOoB,GAAG,EAAE;QACrBb,MAAM,EAAE,MAAM;QACdc,OAAO,EAAE;UACP,cAAc,EAAE;QAClB,CAAC;QACDC,IAAI,EAAEC,IAAI,CAACC,SAAS,CAACb,OAAO,CAAC;QAC7BI;MACF,CAAC,CAAC,CACDU,IAAI,CAAEhD,GAAG,IAAKA,GAAG,CAACiD,IAAI,CAAC,CAAC,CAAC,CACzBD,IAAI,CAAEhD,GAAG,IAAK;QAAA,IAAAkD,sBAAA,EAAAC,sBAAA,EAAAC,sBAAA;QACb,IAAIpD,GAAG,CAACqD,EAAE,KAAKnB,OAAO,CAACmB,EAAE,EAAE;UACzB,MAAM,IAAIC,+BAAmB,CAACpB,OAAO,CAACmB,EAAE,EAAErD,GAAG,CAACqD,EAAE,CAAC;QACnD;QACA,IAAIrD,GAAG,CAACuD,KAAK,EAAE;UACb,MAAM,IAAIC,6BAAiB,CAACV,IAAI,CAACC,SAAS,CAAC/C,GAAG,CAACuD,KAAK,CAAC,CAAC;QACxD;QACA,QAAAL,sBAAA,IAAAC,sBAAA,GAAO,CAAAC,sBAAA,GAAArC,qBAAA,KAAI,EAAAO,QAAA,GAAUU,gBAAgB,cAAAmB,sBAAA,uBAA9BA,sBAAA,CAAAlD,IAAA,CAAAmD,sBAAA,EAAiCpD,GAAG,CAACyD,MAAM,CAAC,cAAAP,sBAAA,cAAAA,sBAAA,GAAIlD,GAAG,CAACyD,MAAM;MACnE,CAAC,CAAC;MAEJC,YAAY,CAACnB,OAAO,CAAC;MACrB,OAAOvC,GAAG;IACZ,CAAC;IAAAlB,eAAA,qBAEmB,CAAC,GAAGmD,MAAoC,KAAK;MAC/D,MAAM0B,IAAI,GAAG1B,MAAM,CAAC2B,GAAG,CACrB,CAACC,CAAC,EAAEC,CAAC,KACF/C,qBAAA,KAAI,EAAAO,QAAA,EAAUS,gBAAgB,CAAC+B,CAAC,CAAC,IAChC/C,qBAAA,KAAI,EAAAO,QAAA,EAAUS,gBAAgB,CAAC+B,CAAC,CAAC,CAACD,CAAC,CAAC,IACtCA,CACJ,CAAC;MACD,MAAMR,EAAE,GAAGU,IAAI,CAACC,KAAK,CAACD,IAAI,CAACE,MAAM,CAAC,CAAC,GAAG,KAAK,CAAC;MAC5C,MAAM/B,OAAO,GAAG;QACdmB,EAAE;QACFvB,MAAM,EAAEf,qBAAA,KAAI,EAAAO,QAAA,EAAUQ,MAAM;QAC5BG,MAAM,EAAE0B,IAAI;QACZO,OAAO,EAAE;MACX,CAAC;MACD,OAAOhC,OAAO;IAChB,CAAC;IA5DCxB,qBAAA,KAAI,EAAAa,KAAA,EAASI,IAAI;IACjBjB,qBAAA,KAAI,EAAAY,QAAA,EAAYM,OAAO;IACvBlB,qBAAA,KAAI,EAAAS,KAAA,EAASS,OAAO,CAACH,IAAI;IACzB,MAAM;MAAEc,OAAO,EAAPA,QAAO,GAAG,KAAK;MAAEG,KAAK,GAAGyB;IAAO,CAAC,GAAGtC,MAAM;IAClDnB,qBAAA,KAAI,EAAAW,OAAA,EAAW;MAAEkB,OAAO,EAAPA,QAAO;MAAEG;IAAM,CAAC;IAEjCxD,MAAM,CAACC,cAAc,CAAC,IAAI,CAACc,IAAI,EAAE,MAAM,EAAE;MACvCjB,KAAK,EAAE4C,OAAO,CAACH,IAAI;MACnBpC,YAAY,EAAE,KAAK;MACnBC,QAAQ,EAAE;IACZ,CAAC,CAAC;EACJ;AAkDF;AACA;AAAA8E,OAAA,CAAA5C,MAAA,GAAAA,MAAA"}