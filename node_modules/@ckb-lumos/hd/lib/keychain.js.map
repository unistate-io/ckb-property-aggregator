{"version":3,"file":"keychain.js","names":["_crypto","_interopRequireDefault","require","_elliptic","_bn","_key","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","ec","EC","EMPTY_BUFFER","Buffer","from","Keychain","constructor","privateKey","chainCode","isNeutered","publicKey","privateToPublic","calculateFingerprint","identifier","hash160","fingerprint","slice","readUInt32BE","fromSeed","seed","i","crypto","createHmac","update","digest","keychain","fromPublicKey","path","pathComponents","split","depth","length","index","parseInt","deriveChild","hardened","data","indexBuffer","allocUnsafe","pk","concat","alloc","writeUInt32BE","il","ir","child","publicKeyAdd","privateKeyAdd","parentFingerprint","derivePath","master","includes","bip32","entries","forEach","c","childIndex","sha256","createHash","factor","result","BN","iadd","cmp","curve","n","isub","toArrayLike","x","toRed","red","y","redSqr","redIMul","redIAdd","b","redSqrt","isOdd","redNeg","point","g","mul","add","encode","exports"],"sources":["../src/keychain.ts"],"sourcesContent":["import crypto from \"crypto\";\nimport { ec as EC } from \"elliptic\";\nimport BN from \"bn.js\";\nimport { privateToPublic } from \"./key\";\n\nconst ec = new EC(\"secp256k1\");\n\nconst EMPTY_BUFFER = Buffer.from(\"\");\n\n// BIP32 Keychain. Not a full implementation.\nexport default class Keychain {\n  privateKey: Buffer = EMPTY_BUFFER;\n  publicKey: Buffer = EMPTY_BUFFER;\n  chainCode: Buffer = EMPTY_BUFFER;\n  index: number = 0;\n  depth: number = 0;\n  identifier: Buffer = EMPTY_BUFFER;\n  fingerprint: number = 0;\n  parentFingerprint: number = 0;\n\n  constructor(privateKey: Buffer, chainCode: Buffer) {\n    this.privateKey = privateKey;\n    this.chainCode = chainCode;\n\n    if (!this.isNeutered()) {\n      this.publicKey = privateToPublic(this.privateKey);\n    }\n  }\n\n  calculateFingerprint(): void {\n    this.identifier = this.hash160(this.publicKey);\n    this.fingerprint = this.identifier.slice(0, 4).readUInt32BE(0);\n  }\n\n  public static fromSeed(seed: Buffer): Keychain {\n    const i = crypto\n      .createHmac(\"sha512\", Buffer.from(\"Bitcoin seed\", \"utf8\"))\n      .update(seed)\n      .digest();\n    const keychain = new Keychain(i.slice(0, 32), i.slice(32));\n    keychain.calculateFingerprint();\n    return keychain;\n  }\n\n  // Create a child keychain with extended public key and path.\n  // Children of this keychain should not have any hardened paths.\n  public static fromPublicKey(\n    publicKey: Buffer,\n    chainCode: Buffer,\n    path: String\n  ): Keychain {\n    const keychain = new Keychain(EMPTY_BUFFER, chainCode);\n    keychain.publicKey = publicKey;\n    keychain.calculateFingerprint();\n\n    const pathComponents = path.split(\"/\");\n    keychain.depth = pathComponents.length - 1;\n    keychain.index = parseInt(pathComponents[pathComponents.length - 1], 10);\n\n    return keychain;\n  }\n\n  public deriveChild(index: number, hardened: boolean): Keychain {\n    let data: Buffer;\n\n    const indexBuffer: Buffer = Buffer.allocUnsafe(4);\n\n    if (hardened) {\n      const pk = Buffer.concat([Buffer.alloc(1, 0), this.privateKey]);\n      indexBuffer.writeUInt32BE(index + 0x80000000, 0);\n      data = Buffer.concat([pk, indexBuffer]);\n    } else {\n      indexBuffer.writeUInt32BE(index, 0);\n      data = Buffer.concat([this.publicKey, indexBuffer]);\n    }\n\n    const i = crypto.createHmac(\"sha512\", this.chainCode).update(data).digest();\n    const il = i.slice(0, 32);\n    const ir = i.slice(32);\n\n    let child: Keychain;\n    if (this.isNeutered()) {\n      child = new Keychain(EMPTY_BUFFER, ir);\n      child.publicKey = Keychain.publicKeyAdd(this.publicKey, il);\n      child.calculateFingerprint();\n    } else {\n      const privateKey = Keychain.privateKeyAdd(this.privateKey, il);\n      child = new Keychain(privateKey, ir);\n      child.calculateFingerprint();\n    }\n\n    child.index = index;\n    child.depth = this.depth + 1;\n    child.parentFingerprint = this.fingerprint;\n\n    return child;\n  }\n\n  public derivePath(path: string): Keychain {\n    const master = [\"m\", `/`, \"\"];\n    if (master.includes(path)) {\n      return this;\n    }\n\n    let bip32: Keychain = this;\n\n    let entries = path.split(\"/\");\n    if (entries[0] === \"m\") {\n      entries = entries.slice(1);\n    }\n    entries.forEach((c) => {\n      const childIndex = parseInt(c, 10);\n      const hardened = c.length > 1 && c[c.length - 1] === \"'\";\n      bip32 = bip32.deriveChild(childIndex, hardened);\n    });\n\n    return bip32;\n  }\n\n  isNeutered(): Boolean {\n    return this.privateKey === EMPTY_BUFFER;\n  }\n\n  hash160(data: Buffer): Buffer {\n    const sha256 = crypto.createHash(\"sha256\").update(data).digest();\n    return crypto.createHash(\"ripemd160\").update(sha256).digest();\n  }\n\n  private static privateKeyAdd(privateKey: Buffer, factor: Buffer): Buffer {\n    const result = new BN(factor);\n    result.iadd(new BN(privateKey));\n    if (result.cmp(ec.curve.n) >= 0) {\n      result.isub(ec.curve.n);\n    }\n\n    return result.toArrayLike(Buffer, \"be\", 32);\n  }\n\n  private static publicKeyAdd(publicKey: Buffer, factor: Buffer): Buffer {\n    const x = new BN(publicKey.slice(1)).toRed(ec.curve.red);\n    let y = x.redSqr().redIMul(x).redIAdd(ec.curve.b).redSqrt();\n    if ((publicKey[0] === 0x03) !== y.isOdd()) {\n      y = y.redNeg();\n    }\n    const point = ec.curve.g.mul(new BN(factor)).add({ x, y });\n    return Buffer.from(point.encode(true, true));\n  }\n}\n"],"mappings":"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"}